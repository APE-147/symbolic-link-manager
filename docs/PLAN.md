# PLAN

> 每次运行在文件底部追加一个 Cycle（6–8 个问题 + 选项效果 + 进度）。

## Cycle 1 — 2025-10-18

Progress
- 来自 TASKS 顶层复选框：4/9（44%）

Decision Questions（以 Questionary 交互为核心）
1) 扫描范围来源？
   - 选项：固定为「/Users/username/Developer/Data」；CLI 参数传入；从配置文件读取（如 `~/.config/slm.yml`）。
   - 影响：固定路径实现最快但不灵活；CLI 最灵活；配置文件便于复用与团队共享。

2) 如何发现“被指向”的文件夹？
   - 选项：仅检查 Home 目录内符号链接；检查一组可配置根目录；全盘扫描（排除系统路径）。
   - 影响：Home 范围速度快、覆盖有限；可配置根目录在速度与覆盖间折中；全盘扫描最全但最慢、权限风险高。

3) 多级菜单交互流程？
   - 选项：
     A. 先选“被指向的目标文件夹”→ 再选“哪些符号链接指向它”→ 输入新目标路径；
     B. 先选“符号链接来源”→ 显示其当前目标及所在 Data 子目录→ 输入新目标路径。
   - 影响：A 符合“围绕 Data 目录整理”的心智；B 便于逐个源链接处理。默认 A。

4) 迁移语义与原链接处理？
   - 选项：移动目录并原地更新符号链接指向新路径；复制后切换符号链接、成功再删除旧目录；仅验证不改动（dry-run）。
   - 影响：移动最快但跨卷可能失败；复制更安全但耗时；dry-run 用于预检查和演示。

5) 目标存在/冲突策略？
   - 选项：禁止覆盖（失败即停）；允许合并（同名文件冲突失败）；启用自动备份为 `dest~TIMESTAMP` 后再移动。
   - 影响：禁止覆盖最安全但可能需要手动清理；合并易出错；备份可回滚但占用空间。

6) 原子性与跨卷移动实现？
   - 选项：优先 `os.rename`，跨卷回退到 `rsync --archive` 或 `shutil.copytree`+校验+删除；
     使用临时目录与最终换名实现“近似原子”。
   - 影响：保证一致性与可恢复性，提高实现复杂度。

7) 校验与回滚策略？
   - 选项：迁移前后对比文件树摘要（数量/大小/哈希可选）；写入操作日志（JSON）；提供一键回滚脚本。
   - 影响：提高可审计性与安全性，成本是更多 I/O 与实现时间。

8) 权限与忽略清单？
   - 选项：需要 sudo 时显式失败并给出建议；支持忽略模式（如 `node_modules`, `.venv`, `.*`）；
     仅处理目录型符号链接（默认）。
   - 影响：降低误操作风险，减少噪音，保证可重复性。

建议默认值
- 扫描范围：可配置根目录，默认 `~` 与常用工作根（含 `/Users/username/Developer`）。
- 交互流程：方案 A（以 Data 目录为中心）。
- 迁移：先 dry-run，确认后执行“移动+更新符号链接+验证”，跨卷自动回退复制策略。
- 冲突：启用自动备份后再移动；全程记录 JSON 日志与回滚指令。
